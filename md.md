# 蔵書管理Webアプリ 仕様書 (拡張版)

## 1. 概要

- **プロジェクト名**: 蔵書管理システム (Book Manager)
- **目的**: 個人の蔵書をWebアプリで管理する
- **開発環境**: Windows, Bun
- **使用技術**: Svelte, SvelteKit, Tailwind CSS, Google Books API
- **対象ユーザー**: 個人の書籍コレクションを管理したい人

## 2. 機能要件

### 2.1 書籍管理機能

| 機能                              | 詳細                                                     |
| --------------------------------- | -------------------------------------------------------- |
| 書籍追加                          | タイトル、著者（必須）、ISBN、出版日（任意）を入力       |
| 書籍一覧                          | カード形式で全書籍を表示                                 |
| 状態管理                          | 「利用可能」「貸出中」の状態を切り替え                   |
| 書籍削除                          | 一覧から書籍を削除                                       |
| **ISBN自動入力**                  | **ISBN入力によりGoogle Books APIから書籍情報を自動取得** |
| **データインポート/エクスポート** | **JSON形式でのデータバックアップと復元**                 |

### 2.2 UI/UX要件

- **デザイン**: モダンでシンプルなUI
- **カラーテーマ**: ダークモードベース
- **レスポンシブ**: モバイル/タブレット/PC対応
- **操作性**: 直感的な操作と視覚的フィードバック
- **ローディング状態**: API呼び出し中の視覚的フィードバック
- **エラーメッセージ**: エラー発生時のユーザーフレンドリーな通知

## 3. 技術仕様

### 3.1 アーキテクチャ

```
┌─────────────────┐
│   SvelteKit     │
├─────────────────┤
│   Components    │
│   ├── AddBookForm │
│   ├── BookList   │
│   ├── BackupRestore │
│   └── Layout     │
├─────────────────┤
│   Stores        │
│   └── books     │
├─────────────────┤
│   Utils         │
│   └── bookApi   │
├─────────────────┤
│   Tailwind CSS  │
└─────────────────┘
```

### 3.2 ディレクトリ構造

```
book-manager/
├── src/
│   ├── lib/
│   │   ├── components/
│   │   │   ├── AddBookForm.svelte
│   │   │   ├── BookList.svelte
│   │   │   └── BackupRestore.svelte
│   │   ├── stores/
│   │   │   └── books.ts
│   │   ├── types/
│   │   │   └── book.ts
│   │   └── utils/
│   │       └── bookApi.ts
│   ├── routes/
│   │   ├── +layout.svelte
│   │   └── +page.svelte
│   ├── app.css
│   └── app.html
├── static/
├── .env
├── tailwind.config.js
├── postcss.config.js
├── svelte.config.js
├── vite.config.ts
└── package.json
```

### 3.3 データモデル

```typescript
interface Book {
	id: string; // UUID
	title: string; // 書籍タイトル（必須）
	author: string; // 著者（必須）
	isbn?: string; // ISBN（任意）
	publishedDate?: string; // 出版日（任意）
	status: 'available' | 'borrowed'; // 状態
}
```

### 3.4 主要コンポーネント

#### AddBookForm.svelte

- **役割**: 書籍追加フォーム
- **状態**: title, author, isbn, publishedDate, isLoading, errorMessage
- **イベント**:
  - フォーム送信時にbooksStore.addBook()を呼び出し
  - ISBN入力時にGoogle Books APIを呼び出し
- **UI**:
  - 入力フィールド（タイトル、著者、ISBN、出版日）
  - ISBN検索ボタン
  - 追加ボタン
  - ローディングインジケーター
  - エラーメッセージ表示

#### BookList.svelte

- **役割**: 書籍一覧表示
- **データ**: $booksStoreを購読
- **イベント**:
  - 貸出/返却ボタン: booksStore.updateStatus()
  - 削除ボタン: booksStore.removeBook()
- **UI**:
  - カード形式で書籍を表示
  - 状態に応じた色分け（利用可能:緑、貸出中:赤）

#### BackupRestore.svelte

- **役割**: データのバックアップと復元
- **機能**:
  - エクスポート: 現在の書籍データをJSONファイルとしてダウンロード
  - インポート: JSONファイルから書籍データを読み込み
- **UI**:
  - エクスポートボタン
  - ファイル選択ボタン（インポート用）

#### books.ts (Store)

- **役割**: 書籍データの状態管理
- **メソッド**:
  - `subscribe`: ストアの変更を購読
  - `addBook`: 新規書籍を追加
  - `removeBook`: 書籍を削除
  - `updateStatus`: 状態を更新
  - `importBooks`: インポートした書籍データを設定

#### bookApi.ts (ユーティリティ)

- **役割**: Google Books APIとの連携
- **関数**:
  - `fetchBookByISBN`: ISBNから書籍情報を取得

## 4. UIデザイン仕様

### 4.1 カラースキーム

| 要素             | ダークモード | ライトモード |
| ---------------- | ------------ | ------------ |
| 背景             | gray-900     | white        |
| カード           | gray-800     | gray-100     |
| 文字             | gray-100     | gray-900     |
| プライマリボタン | indigo-600   | indigo-600   |
| セカンダリボタン | gray-500     | gray-500     |
| 削除ボタン       | red-600      | red-600      |
| 状態（利用可能） | green-600    | green-600    |
| 状態（貸出中）   | red-600      | red-600      |
| エラーメッセージ | red-500      | red-500      |

### 4.2 レイアウト

- **ヘッダー**: 「蔵書管理システム」タイトル
- **メインコンテンツ**:
  - 上部: 書籍追加フォーム
  - 中部: 書籍一覧
  - 下部: バックアップ/復元機能
- **レスポンシブ**:
  - モバイル: 1列表示
  - タブレット/PC: 適切な最大幅で中央配置

### 4.3 コンポーネント詳細

#### 書籍追加フォーム（拡張版）

```
┌─────────────────────────────────────┐
│ ■ 新規書籍追加                      │
├─────────────────────────────────────┤
│ ISBN [_______________] [検索]       │
│                                     │
│ タイトル       [_______________]    │
│ 著者           [_______________]    │
│ 出版日         [_______________]    │
│                                     │
│ [        書籍を追加        ]        │
└─────────────────────────────────────┘
```

#### バックアップ/復元機能

```
┌─────────────────────────────────────┐
│ ■ バックアップ/復元                 │
├─────────────────────────────────────┤
│ [エクスポート] [ファイルを選択]     │
└─────────────────────────────────────┘
```

## 5. 新機能の詳細仕様

### 5.1 ISBN自動入力機能

#### 5.1.1 概要

- **目的**: ISBNを入力するだけで書籍情報（タイトル、著者、出版日）を自動的に取得し、フォームに入力する
- **外部API**: Google Books APIを使用
- **トリガー**: ISBN入力後に検索ボタンをクリック

#### 5.1.2 技術仕様

- **APIエンドポイント**: `https://www.googleapis.com/books/v1/volumes?q=isbn:ISBN`
- **環境変数**: `.env`ファイルに`PUBLIC_GOOGLE_BOOKS_API_KEY`を設定
- **ユーティリティ関数**: `src/lib/utils/bookApi.ts`に`fetchBookByISBN`関数を実装

```typescript
// src/lib/utils/bookApi.ts
export async function fetchBookByISBN(
	isbn: string
): Promise<{ title?: string; authors?: string; publishedDate?: string } | null> {
	const apiKey = import.meta.env.PUBLIC_GOOGLE_BOOKS_API_KEY;
	const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${encodeURIComponent(isbn)}${apiKey ? `&key=${apiKey}` : ''}`;
	try {
		const response = await fetch(url);
		if (!response.ok) {
			throw new Error('APIリクエストに失敗しました');
		}
		const data = await response.json();
		if (data.totalItems === 0) {
			return null;
		}
		const book = data.items[0].volumeInfo;
		return {
			title: book.title,
			authors: Array.isArray(book.authors) ? book.authors.join(', ') : undefined,
			publishedDate: book.publishedDate
		};
	} catch (error) {
		console.error('書籍データの取得に失敗:', error);
		return null;
	}
}
```

#### 5.1.3 UI/UX仕様

- **ローディング状態**: API呼び出し中は検索ボタンを「検索中...」に変更し、無効化
- **エラーメッセージ**: 書籍が見つからない場合やAPIエラー時にエラーメッセージを表示
- **バリデーション**: ISBNの形式チェック（10桁または13桁の数字）
- **自動入力**: 取得したデータを各フィールドに自動入力

#### 5.1.4 エラーハンドリング

- **ISBN形式エラー**: 有効なISBN形式でない場合のエラーメッセージ
- **APIエラー**: Google Books APIへのアクセスエラー
- **データなしエラー**: 指定されたISBNの書籍が見つからない場合

### 5.2 データインポート/エクスポート機能

#### 5.2.1 概要

- **目的**: 書籍データのバックアップと復元を可能にする
- **データ形式**: JSON
- **機能**:
  - エクスポート: 現在の書籍データをJSONファイルとしてダウンロード
  - インポート: JSONファイルから書籍データを読み込み、現在のデータに追加または置換

#### 5.2.2 技術仕様

- **エクスポート処理**:
  1. ストアから書籍データを取得
  2. JSON形式に変換
  3. Blobオブジェクトを作成
  4. ダウンロードリンクを生成し、クリックイベントを発火

- **インポート処理**:
  1. ファイル選択ダイアログを表示
  2. 選択されたファイルを読み込み
  3. JSONをパース
  4. データ形式を検証
  5. ストアにデータを設定

#### 5.2.3 UI/UX仕様

- **エクスポートボタン**: クリックするとJSONファイルがダウンロードされる
- **インポートボタン**: クリックするとファイル選択ダイアログが表示される
- **確認ダイアログ**: インポート時に既存データを上書きするか確認
- **フィードバック**: 処理完了後にアラートで結果を通知

#### 5.2.4 エラーハンドリング

- **ファイル形式エラー**: JSONファイルでない場合のエラー
- **データ形式エラー**: Book型の配列でない場合のエラー
- **パースエラー**: JSONの解析に失敗した場合のエラー

## 6. 開発経緯と課題

### 6.1 技術選定

- **Svelte**: リアクティブなUIを簡単に構築可能
- **SvelteKit**: フルスタックフレームワークとして採用
- **Tailwind CSS**: ユーティリティファーストのCSSフレームワーク
- **Google Books API**: 書籍情報取得のための外部API
- **Melt UI**: 当初は使用を試みたが、APIの不安定さにより断念

### 6.2 主な課題と解決策

| 課題                       | 解決策                                             |
| -------------------------- | -------------------------------------------------- |
| Melt UIのAPI不安定         | シンプルなHTML要素とTailwind CSSに変更             |
| PostCSS設定エラー          | @tailwindcss/postcssをインストールし設定を更新     |
| CSSファイル参照エラー      | src/app.cssを作成しレイアウトでインポート          |
| SSRモジュール解決エラー    | パスエイリアス設定を確認し相対パスでインポート     |
| ISBN自動入力機能の実装     | Google Books APIを利用したユーティリティ関数を作成 |
| データインポート機能の実装 | FileReader APIとBlobオブジェクトを利用             |

### 6.3 開発環境

- **OS**: Windows
- **パッケージマネージャ**: Bun
- **エディタ**: VS Code（推奨）
- **ブラウザ**: Chrome（開発）

## 7. 今後の拡張案

### 7.1 機能拡張

1. **検索機能**: 書籍タイトルや著者での検索
2. **ソート機能**: タイトル、著者、出版日でのソート
3. **フィルタ機能**: 状態（利用可能/貸出中）でのフィルタ
4. **貸出履歴**: 誰にいつ貸出したかの履歴管理
5. **データ永続化**: IndexedDBやlocalStorageへの保存
6. **バックアップ/復元**: ✓ 実装済み
7. **ISBN自動入力**: ✓ 実装済み

### 7.2 UI/UX改善

1. **ダークモード/ライトモード切り替え**
2. **アニメーション**: 状態変化時のトランジション
3. **削除確認**: 削除前の確認ダイアログ
4. **編集機能**: 書籍情報の編集
5. **詳細表示**: 書籍の詳細情報をモーダルで表示
6. **カバー画像**: Google Books APIから取得したカバー画像の表示

### 7.3 技術的改善

1. **バックエンド連携**: データベース（SQLite, PostgreSQL）との連携
2. **ユーザー認証**: 複数ユーザーでの利用
3. **PWA対応**: オフラインでの利用
4. **テスト**: ユニットテスト、E2Eテストの導入
5. **APIキャッシュ**: 同じISBNの検索結果をキャッシュ
6. **デバウンス処理**: ISBN入力時のAPI呼び出しを最適化

## 8. まとめ

- 現時点で基本的な蔵書管理機能に加え、ISBN自動入力機能とデータインポート/エクスポート機能を実装済み
- シンプルでモダンなUIを実現
- 拡張性を考慮した設計
- 今後の機能追加に向けた土台が完成
- Google Books APIを利用した外部連携機能の実装経験を獲得

---

この仕様書はプロジェクトの現状と今後の方向性をまとめたものです。開発の進捗に応じて更新してください。特に新機能の実装に伴う変更点や、今後の拡張計画について詳細に記述しています。
